// VtexMinicart.js
// version: 0.2.2
// author: Wellington Barreto
// license: MIT
!function t(e,n,r){function i(o,s){if(!n[o]){if(!e[o]){var u="function"==typeof require&&require;if(!s&&u)return u(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[o]={exports:{}};e[o][0].call(l.exports,function(t){var n=e[o][1][t];return i(n||t)},l,l.exports,t,e,n,r)}return n[o].exports}for(var a="function"==typeof require&&require,o=0;o<r.length;o++)i(r[o]);return i}({1:[function(t,e,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default={stripHttp:function(t){return t.replace(/^https?:/,"")}}},{}],2:[function(t,e,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=t("./helpers.js"),a=function(t){return t&&t.__esModule?t:{default:t}}(i);!function(t){var e=function(e,n){var r={debug:!1,bodyClass:null};if("VtexHelpers"in window&&(this.vtexHelpers=new VtexHelpers),!(this.vtexHelpers instanceof VtexHelpers))throw new Error("VtexHelpers is required. Download it from https://www.npmjs.com/package/vtex-helpers");this.option=t.extend({},r,n),this.$element=t(e),this.init()};e.prototype={cart:{items:{},itemCount:0},init:function(){this.bindData(),this.fillCart(),this.updateItem(),this.removeItem()},bindData:function(){rivets.bind(this.$element,{controller:e,cart:this.cart})},fillCart:function(){var e=this;this._requestStartEvent(),vtexjs.checkout.getOrderForm().done(function(n){if(e.$element.find("[data-minicart-subtotal]").html(e.vtexHelpers.formatPrice(n.value)),e.cart.itemCount=n.items.length,e.cart.items=n.items,e.cart.itemCount>0){var r=n.items.reduce(function(t,e){return t+e.quantity},0);t("[data-minicart-amount]").text(r),n.items.map(function(t,n){vtexjs.catalog.getProductWithVariations(t.productId).done(function(r){var i=r.skus.filter(function(e){return parseInt(e.sku)===parseInt(t.id)});t.sellingPrice===t.listPrice&&(e.cart.items[n].listPrice=0),e.cart.items[n].imageUrl=a.default.stripHttp(e.cart.items[n].imageUrl),e.cart.items[n].productInfo=r,e.cart.items[n].index=n,e.cart.items[n].availablequantity=i[0].availablequantity,e.cart.items[n].installments=i[0].installments,e.cart.items[n].installmentsInsterestRate=i[0].installmentsInsterestRate,e.cart.items[n].installmentsValue=i[0].installmentsValue,e.cart.items[n].variants=i[0].dimensions})}),e._debug()}else t("[data-minicart-amount]").text(0)}).always(function(t){e._requestEndEvent(t)})},removeItem:function(){var e=this;t(document).on("click","[data-minicart-item-remove]",function(n){var r=t(n.currentTarget).data("minicartIndex");e._removeItem(r)})},updateItem:function(){var e=this;t(document).on("click","[data-minicart-item-qty]",function(n){n.preventDefault();var r=t(n.currentTarget),i=r.parent().find("[data-minicart-item-qty-val]"),a=i.data("minicartIndex"),o=i.data("minicartAvailablequantity"),s=i.val(),u=0;if(o=o||99999,"+"===r.data("minicartItemQty")){if((u=parseFloat(s)+1)>parseInt(o))return!1}else if(s>0){if(0===(u=parseFloat(s)-1))return e._removeItem(a),!1}else u=0;e._updateItem(a,u)})},_debug:function(){this.option.debug&&(window.console.group("VtexMinicart Debbug"),window.console.log(this.cart.items),window.console.groupEnd())},_removeItem:function(t){var e=this;vtexjs.checkout.getOrderForm().then(function(n){e._addLoader();var r=n.items[t];return r.index=t,vtexjs.checkout.removeItems([r])}).done(function(t){e.fillCart(),e._removeLoader(),e._deleteItemEvent(t)})},_updateItem:function(t,e){var n=this;vtexjs.checkout.getOrderForm().then(function(r){n._addLoader();var i={index:t,quantity:e};return vtexjs.checkout.updateItems([i],null,!1)}).done(function(e){n.fillCart(),n._removeLoader(),n._updateItemEvent(e,t)})},_addLoader:function(){this.option.bodyClass&&t("body").addClass(this.option.bodyClass)},_removeLoader:function(){this.option.bodyClass&&t("body").removeClass(this.option.bodyClass)},_requestStartEvent:function(){var e=t.Event("vtexMinicart.requestStart");t(document).trigger(e)},_requestEndEvent:function(e){var n=t.Event("vtexMinicart.requestEnd");t(document).trigger(n,[e])},_updateItemEvent:function(e,n){var r=t.Event("vtexMinicart.update"),i=e.items[n];t(document).trigger(r,[e,n,i])},_deleteItemEvent:function(e){var n=t.Event("vtexMinicart.delete");t(document).trigger(n,[e])}},t.fn.vtexMinicart=function(n){var i=this,a=arguments,o="object"===(void 0===n?"undefined":r(n))&&n;if("boolean"!=typeof n.debug)throw new Error('Option debug should be a "boolean" value');if(null!==n.bodyClass&&"string"!=typeof n.bodyClass)throw new Error('Option bodyClass should be a "string" value.');return this.each(function(r){var s=t(i),u=s.data("vtexMinicart");u||s.data("vtexMinicart",u=new e(i,o)),"string"==typeof n&&(a.length>1?u[n].apply(u,Array.prototype.slice.call(a,1)):u[n]())})}}(jQuery)},{"./helpers.js":1}]},{},[2]);
