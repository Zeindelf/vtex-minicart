// VtexMinicart.js
// version: 0.0.2
// author: Wellington Barreto
// license: MIT
!function t(e,r,n){function i(a,s){if(!r[a]){if(!e[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var f=new Error("Cannot find module '"+a+"'");throw f.code="MODULE_NOT_FOUND",f}var c=r[a]={exports:{}};e[a][0].call(c.exports,function(t){var r=e[a][1][t];return i(r||t)},c,c.exports,t,e,r,n)}return r[a].exports}for(var o="function"==typeof require&&require,a=0;a<n.length;a++)i(n[a]);return i}({1:[function(t,e,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default={stripHttp:function(t){return t.replace(/^https?:/,"")},formatPrice:function(t,e,r,n,i){i="string"==typeof i?i:"R$ ",n="number"!=typeof n?2:n;var o="\\d(?=(\\d{3})+"+(n>0?"\\D":"$")+")";return t/=100,t=(1*t).toFixed(Math.max(0,~~n)),i+t.replace(".",r||",").replace(new RegExp(o,"g"),"$&"+(e||"."))},getResizedImage:function(t,e,r){return t=this.stripHttp(t),void 0===e||void 0===r||"string"!=typeof t?t:(t=t.replace(/(?:ids\/[0-9]+)-([0-9]+)-([0-9]+)\//,function(t,n,i){return t.replace("-"+n+"-"+i,"-"+e+"-"+r)}),t.replace(/(ids\/[0-9]+)\//,"$1-"+e+"-"+r+"/"))}}},{}],2:[function(t,e,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=t("./helpers.js"),o=function(t){return t&&t.__esModule?t:{default:t}}(i);t("./rivets-formatters.js"),function(t){var e=function(e,r){var n={debug:!1,bodyClass:null};this.option=t.extend({},n,r),this.$element=t(e),this.init()};e.prototype={cart:{items:{},itemCount:0},init:function(){this.bindData(),this.fillCart(),this.updateItem(),this.removeItem()},bindData:function(){rivets.bind(this.$element,{controller:e,cart:this.cart})},fillCart:function(){var e=this;this._requestStartEvent(),vtexjs.checkout.getOrderForm().done(function(r){if(e.$element.find("[data-minicart-subtotal]").html("R$ "+o.default.formatPrice(r.value)),e.cart.itemCount=r.items.length,e.cart.items=r.items,e.cart.itemCount>0){var n=r.items.reduce(function(t,e){return t+e.quantity},0);t("[data-minicart-amount]").text(n),r.items.map(function(t,r){vtexjs.catalog.getProductWithVariations(t.productId).done(function(n){var i=n.skus.filter(function(e){return parseInt(e.sku)===parseInt(t.id)});t.sellingPrice===t.listPrice&&(e.cart.items[r].listPrice=0),e.cart.items[r].productInfo=n,e.cart.items[r].index=r,e.cart.items[r].availablequantity=i[0].availablequantity,e.cart.items[r].installments=i[0].installments,e.cart.items[r].installmentsInsterestRate=i[0].installmentsInsterestRate,e.cart.items[r].installmentsValue=i[0].installmentsValue,e.cart.items[r].variants=i[0].dimensions})}),e._debug()}else t("[data-minicart-amount]").text(0)}).always(function(t){e._requestEndEvent(t)})},removeItem:function(){var e=this;t(document).on("click","[data-minicart-item-remove]",function(r){var n=t(r.currentTarget).data("minicartIndex");e._removeItem(n)})},updateItem:function(){var e=this;t(document).on("click","[data-minicart-item-qty]",function(r){r.preventDefault();var n=t(r.currentTarget),i=n.parent().find("[data-minicart-item-qty-val]"),o=i.data("minicartIndex"),a=i.data("minicartAvailablequantity"),s=i.val(),u=0;if("+"===n.data("minicartItemQty")){if((u=parseFloat(s)+1)>a)return!1}else if(s>0){if(0===(u=parseFloat(s)-1))return e._removeItem(o),!1}else u=0;e._updateItem(o,u)})},_debug:function(){this.option.debug&&(window.console.group("VtexMinicart Debbug"),window.console.log(this.cart.items),window.console.groupEnd())},_removeItem:function(t){var e=this;vtexjs.checkout.getOrderForm().then(function(r){e._addLoader();var n=r.items[t];return n.index=t,vtexjs.checkout.removeItems([n])}).done(function(t){e.fillCart(),e._removeLoader(),e._deleteItemEvent(t)})},_updateItem:function(t,e){var r=this;vtexjs.checkout.getOrderForm().then(function(n){r._addLoader();var i={index:t,quantity:e};return vtexjs.checkout.updateItems([i],null,!1)}).done(function(e){r.fillCart(),r._removeLoader(),r._updateItemEvent(e,t)})},_addLoader:function(){this.option.bodyClass&&t("body").addClass(this.option.bodyClass)},_removeLoader:function(){this.option.bodyClass&&t("body").removeClass(this.option.bodyClass)},_requestStartEvent:function(){var e=t.Event("vtexMinicart.requestStart");t(document).trigger(e)},_requestEndEvent:function(e){var r=t.Event("vtexMinicart.requestEnd");t(document).trigger(r,[e])},_updateItemEvent:function(e,r){var n=t.Event("vtexMinicart.update"),i=e.items[r];t(document).trigger(n,[e,r,i])},_deleteItemEvent:function(e){var r=t.Event("vtexMinicart.delete");t(document).trigger(r,[e])}},t.fn.vtexMinicart=function(r){var i=this,o=arguments,a="object"===(void 0===r?"undefined":n(r))&&r;return this.each(function(n){var s=t(i),u=s.data("vtexMinicart");u||s.data("vtexMinicart",u=new e(i,a)),"string"==typeof r&&(o.length>1?u[r].apply(u,Array.prototype.slice.call(o,1)):u[r]())})}}(jQuery)},{"./helpers.js":1,"./rivets-formatters.js":3}],3:[function(t,e,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=t("./helpers.js"),o=function(t){return t&&t.__esModule?t:{default:t}}(i);rivets.formatters["!"]=function(t){return!t},rivets.formatters.eq=function(t,e){return t===e},rivets.formatters.neq=function(t,e){return t!==e},rivets.formatters.gt=function(t,e){return t>e},rivets.formatters.gte=function(t,e){return t>=e},rivets.formatters.lt=function(t,e){return t<e},rivets.formatters.lte=function(t,e){return t<=e},rivets.formatters.or=function(t,e){return t||e},rivets.formatters.isEmpty=function(t){return void 0===t||null===t||"string"==typeof t&&0===t.length},rivets.formatters.isNotEmpty=function(t){return!rivets.formatters.isEmpty(t)},rivets.formatters.pass=function(t,e){return e},rivets.formatters.json=function(t,e){return JSON.stringify(t,null,e||0)},rivets.formatters.prefix=function(t,e){return""+e+t},rivets.formatters.suffix=function(t,e){return""+t+e},rivets.formatters.ucFirst=function(t){return t.substr(0,1).toUpperCase()+t.substr(1)},rivets.formatters["+"]=function(t,e){return t+e},rivets.formatters["-"]=function(t,e){return t-e},rivets.formatters["*"]=function(t,e){return t*e},rivets.formatters["/"]=function(t,e){return t/e},rivets.formatters.round=function(t,e){if(e){var r=Math.pow(10,e);t=Math.round(t*r)/r}else t=Math.round(t);return t},rivets.formatters.get=function(t,e){return t&&"object"===(void 0===t?"undefined":n(t))?t[e]:null},rivets.formatters.set=function(t,e,r){return t&&"object"===(void 0===t?"undefined":n(t))&&(t[e]=r),t},rivets.formatters["."]=rivets.formatters.get,rivets.formatters.keys=function(t){return"object"===(void 0===t?"undefined":n(t))?Object.keys(t):[]},rivets.formatters.length=function(t){return t?t.length||0:0},rivets.formatters.sort=function(){return t;var t},rivets.formatters.default=function(t,e){return void 0!==t&&null!==t?t:e},rivets.formatters.contains=function(t,e){return!!Array.isArray(t)&&-1!==t.indexOf(e)},rivets.formatters.percent=function(t,e){return number_format(100*t,e||0,",")+"%"},rivets.formatters.bind=function(){var t=Array.from(arguments),e=t.shift(),r=t.shift();return"function"==typeof e?function(){e.apply(r,t)}:e},rivets.formatters.with=function(){var t=Array.from(arguments);console.log(t);var e=t.shift();return"function"==typeof e?e.bind(null,t):e},rivets.formatters.slice=function(){var t=Array.from(arguments),e=t.shift();return Array.prototype.slice.apply(e,t)},rivets.formatters.formatPrice=function(t){return o.default.formatPrice(t)},rivets.formatters.productImgSize=function(t,e,r){return o.default.getResizedImage(t,e,r)}},{"./helpers.js":1}]},{},[2]);
